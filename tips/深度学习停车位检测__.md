# 深度学习停车位检测

## 1. 其他方法

之前看的一些方法普遍有两个问题：

- 模型太大，动辄100+MB
- 很多依赖复杂或者针对特殊场景的后处理

## 2. ti-psd

### 2.1 复现过程

1. [app_tidl_avp](.\\ti-psd\\vision_apps_user_guide\\group_apps_dl_demos_app_tidl_avp.html): 在sdk的user guide中，发现vision_apps/apps/dl_demos/app_tidl_avp有ti针对鱼眼单视图做的一阶段深度学习停车位检测模型。
2. [app_avp.cfg](.\\ti-psd\\app_avp.cfg): 找到该app使用的文件是tidl_net_jpsdNet.bin，并在ti另外提供的psdk_rtos_ti_data_set文件找到这个转换后的模型文件。
3. [tidl_net_jpsdNet.svg](.\\ti-psd\\tidl_net_jpsdNet.bin.svg): 在ti_dl/inc/itidl_ti.h中找到模型文件的结构体，然后可以解出模型主体结构图，模型主体使用SSD。
4. [ti-psd](./ti-psd): 在ti_dl/algo/src/tidl_detectionOutput.c中可以找到模型检测头后处理的解码方法，SSD检测头的分类分支不变，回归分支每个anchor在原基础上加上四个角点的坐标信息(dx1, dy1, dx2, dy2, dx3, dy3, dx4, dy4), (Cx, Cy, w, h)解码时乘的stds为原版SSD的(0.1, 0.1, 0.2, 0.2)，后面八个新增的部分乘的值都是0.05。
5. [ssdlite_kp model.svg](.\\ti-psd\\ssdlite_kp_fpn_rnx8_512_512.svg): 由模型倒推得到所需要的标注是每个车位标四个角点，当时正好有一批300张左右鱼眼单视图现成的标注好的数据可以用来测试模型。然后用这批数据复现了这个模型，再把这个模型用tidl转换得到的bin模型输出经测试也是对的。
6. [验证集上效果](.\\ti-psd\\ssdlite_kp_val_mono20211230)

### 2.2 后续

#### 鱼眼单视图关键点模型检测存在的问题：

- 移动过程中车位的形变过大
- 车位后面的两个点经常被遮挡，即使看到了也很模糊
- 需要同时跑多路模型，负载会比较大
- 经常被遮挡还导致了标注困难，标注时后面的点基本靠猜

所以之后尝试和传统算法一样，在拼接图下检测车位。

最开始用的依旧是这个检关键点的模型，用公开数据集训练了第一版模型，训练得到的模型在这个数据集上效果很好：[效果](.\\ti-psd\\ssdlite_kp_avm_context)

然后按照逆时针顺序以及点1、4为入口点的规则，用公司以前采集的视频标了一批环视拼接图的数据，这批数据下[训练集效果](.\\ti-psd\\ssdlite_kp_avm_lh)很好，但是换到新环境[误检很严重](.\\ti-psd\\ssdlite_kp_val_avm_error)。

#### 环视拼接图下关键点模型存在的问题：

- 关键点的顺序冲突导致仍然需要取ROI，分左右两路检测
- 后面的两个点不出现在画面里，几乎全标注在了图片边缘
- 误检比较多

## 3. yolo-psd

#### 针对上面存在的问题：

1. 自己设计检测头，改为检测入口中心点+两个角度+入口线长度，可以解决点的顺序冲突问题和后面两个点难以标注的问题。
2. 模型主干网络和分类分支的损失函数参考yolov5和yolov7，
3. 回归分支的损失函数沿用之前tissd-psd的损失函数。
4. 数据沿用之前四个点的标注方式（不需要固定逆时针顺序以及后面两个点的精确位置，可以显著减少标注时间，且之前的标注还能在这个模型用）

#### [模型部署](.\\yolo-psd)

|                | 模型大小(MB) | 算力要求(1cycle) |
| -------------- | ------------ | ---------------- |
| 初版模型       | 30.3         | 11.0GFLOPs       |
| 轻量化backbone | 7.62         | 3.25GFLOPs       |
| 针对tda4优化   | 5.41         | 2.86GFLOPs       |
| tda4量化后     | 2.24         | 2.86GOPs         |
| 针对tda2优化   | 3.74         | 0.96GFLOPs       |
| tda2量化后     | 1.39         | 0.96GOPs         |

tda4的模型转换在7~8的所有版本的sdk上均通过，sdk的pc模拟运行在sdk7.01和sdk8.04验证通过。[tda4运行效果](.\\yolo-psd\\app_tidl_psd_out_v7n_8b_3123)



